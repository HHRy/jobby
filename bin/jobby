#!/usr/bin/env ruby
require "#{File.dirname(__FILE__)}/../lib/server"
require "#{File.dirname(__FILE__)}/../lib/client"

# socket probably wants to live in shared directory
@socket = "/tmp/jobby"
@max_child_processes = 3
begin
  # Try to connect to the server process
  Jobby::Client.new(@socket) { |client| client.send("begin") }
rescue Errno::ECONNREFUSED
  # Connect failed, fork and start the server process
  fork do
    Jobby::Server.new(@socket, @max_child_processes).run
  end
  Jobby::Client.new(@socket) { |client| client.send("rescue") }
ensure
  # test code
  10.times do |count|
    Jobby::Client.new(@socket) { |client| client.send("#{count}") }
  end
end
